<!--pages/product/detail/index.wxml - å®Œæ•´çš„å•†å“è¯¦æƒ…é¡µ-->
<view class="container">

  <!-- é¡µé¢åŠ è½½çŠ¶æ€ -->
  <view class="page-loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <scroll-view class="main-content" scroll-y="{{true}}" wx:if="{{!loading && product}}">
    
    <!-- å•†å“å›¾ç‰‡è½®æ’­ -->
    <view class="product-gallery">
      <swiper class="gallery-swiper" 
              indicator-dots="{{previewImages.length > 1}}"
              indicator-color="rgba(255,255,255,0.5)"
              indicator-active-color="#ffffff"
              autoplay="{{false}}"
              circular="{{true}}"
              bindchange="onImageChange">
        <swiper-item wx:for="{{previewImages}}" wx:key="index">
          <image class="gallery-image" 
                 src="{{item}}" 
                 mode="aspectFill"
                 data-index="{{index}}"
                 bindtap="previewImage"
                 lazy-load="{{true}}"></image>
        </swiper-item>
      </swiper>
      
      <!-- å›¾ç‰‡æŒ‡ç¤ºå™¨ï¼ˆè‡ªå®šä¹‰ï¼‰ -->
      <view class="custom-indicator" wx:if="{{previewImages.length > 1}}">
        <text class="indicator-text">{{currentImageIndex + 1}}/{{previewImages.length}}</text>
      </view>

      <!-- å•†å“æ ‡ç­¾ -->
      <view class="product-tags" wx:if="{{product.is_hot || product.is_new || product.is_recommend}}">
        <text class="product-tag hot" wx:if="{{product.is_hot}}">çƒ­é—¨</text>
        <text class="product-tag new" wx:if="{{product.is_new}}">æ–°å“</text>
        <text class="product-tag recommend" wx:if="{{product.is_recommend}}">æ¨è</text>
      </view>

      <!-- æ”¶è—å’Œåˆ†äº«æŒ‰é’® -->
      <view class="action-buttons">
        <view class="action-btn favorite-btn {{isFavorite ? 'active' : ''}}" bindtap="toggleFavorite">
          <text class="iconfont icon-heart"></text>
        </view>
        <view class="action-btn share-btn" bindtap="showShare">
          <text class="iconfont">ğŸ“¤</text>
        </view>
      </view>
    </view>

    <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
    <view class="product-basic-info">
      
      <!-- ä»·æ ¼åŒºåŸŸ -->
      <view class="price-section">
        <!-- å½“å‰ä»·æ ¼ -->
        <view class="current-price">
          <text class="currency">Â¥</text>
          <text class="price-value">{{formatPrice(product.current_price)}}</text>
        </view>
        
        <!-- åŸä»·å¯¹æ¯” -->
        <view class="price-compare" wx:if="{{product.original_price && product.current_price && product.original_price > product.current_price}}">
          <text class="original-price">Â¥{{formatPrice(product.original_price)}}</text>
          <text class="discount-tag">{{calculateDiscount(product.original_price, product.current_price)}}æŠ˜</text>
        </view>
        
        <!-- å›¢è´­ä»·æ ¼æç¤º -->
        <view class="group-price-tip" wx:if="{{product.group_price && product.group_price < product.current_price}}">
          <text class="group-price-text">å›¢è´­ä»· Â¥{{formatPrice(product.group_price)}}</text>
          <text class="group-save-text">å¯çœ{{formatPrice(product.current_price - product.group_price)}}å…ƒ</text>
        </view>
      </view>

      <!-- å•†å“æ ‡é¢˜å’Œæè¿° -->
      <view class="product-title">{{product.name}}</view>
      <view class="product-subtitle" wx:if="{{product.description}}">{{product.description}}</view>
      
      <!-- é”€é‡å’Œåº“å­˜ä¿¡æ¯ -->
      <view class="product-stats">
        <text class="sales-text">å·²å”®{{formatSales(product.sales)}}</text>
        <text class="stock-text" wx:if="{{product.stock && product.stock <= 10 && product.stock > 0}}">ä»…å‰©{{product.stock}}ä»¶</text>
        <text class="stock-text out-of-stock" wx:elif="{{product.stock === 0}}">å·²å”®ç½„</text>
        <text class="reviews-text" wx:if="{{reviewStats && reviewStats.total_count > 0}}" bindtap="viewAllReviews">
          {{reviewStats.total_count}}æ¡è¯„ä»· â­{{reviewStats.average_rating}}åˆ†
        </text>
      </view>
    </view>

    <!-- å›¢è´­ä¿¡æ¯åŒºåŸŸ -->
    <view class="group-section" wx:if="{{activeGroups.length > 0}}">
      <view class="section-header">
        <text class="section-title">ğŸ¯ è¿›è¡Œä¸­çš„å›¢è´­</text>
        <text class="section-subtitle">æ›´ä¼˜æƒ çš„ä»·æ ¼ç­‰ä½ æ¥</text>
      </view>
      
      <scroll-view class="group-list" scroll-x="{{true}}">
        <view class="group-item" wx:for="{{activeGroups}}" wx:key="id" 
              data-group-id="{{item.id}}" bindtap="joinGroup">
          <view class="group-header">
            <text class="group-price">Â¥{{formatPrice(item.group_price)}}</text>
            <text class="group-people">{{item.required_people}}äººå›¢</text>
          </view>
          <view class="group-progress">
            <progress percent="{{(item.current_people / item.required_people) * 100}}" 
                      stroke-width="6" 
                      activeColor="#FF4D4F"
                      backgroundColor="#f5f5f5"></progress>
          </view>
          <view class="group-info">
            <text class="group-status">è¿˜å·®{{item.required_people - item.current_people}}äºº</text>
            <text class="group-time">{{item.remaining_time || '2å°æ—¶'}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- å•†æˆ·ä¿¡æ¯ -->
    <view class="merchant-section" wx:if="{{merchant}}" bindtap="viewMerchant">
      <view class="merchant-card">
        <image class="merchant-logo" src="{{merchant.logo || '/assets/images/logo.png'}}" mode="aspectFill"></image>
        <view class="merchant-info">
          <text class="merchant-name">{{merchant.name}}</text>
          <view class="merchant-stats">
            <text class="merchant-rating" wx:if="{{merchant.rating}}">â­ {{merchant.rating}}åˆ†</text>
            <text class="merchant-distance" wx:if="{{deliveryInfo && deliveryInfo.distance}}">{{deliveryInfo.distance}}</text>
          </view>
          <text class="delivery-info" wx:if="{{deliveryInfo}}">
            é…é€è´¹Â¥{{deliveryInfo.fee || 0}} Â· é¢„è®¡{{deliveryInfo.time || '30-45åˆ†é’Ÿ'}}é€è¾¾
          </text>
        </view>
        <view class="merchant-arrow">
          <text class="arrow-icon">></text>
        </view>
      </view>
    </view>

    <!-- è§„æ ¼é€‰æ‹© -->
    <view class="spec-section" wx:if="{{product.specifications && product.specifications.length > 0}}">
      <view class="spec-selector" bindtap="showSpecSelector" data-mode="buy">
        <text class="spec-label">è§„æ ¼</text>
        <text class="spec-value">{{getSpecDescription()}}</text>
        <text class="spec-arrow">></text>
      </view>
    </view>

    <!-- å•†å“è¯¦æƒ… -->
    <view class="product-detail-section">
      <view class="section-header">
        <text class="section-title">å•†å“è¯¦æƒ…</text>
      </view>
      
      <!-- å•†å“æè¿° -->
      <view class="product-description" wx:if="{{product.detail_description}}">
        <rich-text nodes="{{product.detail_description}}"></rich-text>
      </view>
      
      <!-- ç®€å•æè¿°å±•ç¤º -->
      <view class="product-description" wx:elif="{{product.description}}">
        <text>{{product.description}}</text>
      </view>
      
      <!-- å•†å“å‚æ•° -->
      <view class="product-params" wx:if="{{product.parameters && product.parameters.length > 0}}">
        <view class="param-item" wx:for="{{product.parameters}}" wx:key="name">
          <text class="param-label">{{item.name}}</text>
          <text class="param-value">{{item.value}}</text>
        </view>
      </view>

      <!-- åŸºæœ¬å‚æ•°å±•ç¤º -->
      <view class="product-params" wx:else>
        <view class="param-item">
          <text class="param-label">å•†å“åç§°</text>
          <text class="param-value">{{product.name}}</text>
        </view>
        <view class="param-item" wx:if="{{product.unit}}">
          <text class="param-label">é”€å”®å•ä½</text>
          <text class="param-value">{{product.unit}}</text>
        </view>
        <view class="param-item">
          <text class="param-label">åº“å­˜æ•°é‡</text>
          <text class="param-value">{{product.stock}}ä»¶</text>
        </view>
        <view class="param-item" wx:if="{{product.weight}}">
          <text class="param-label">å•†å“é‡é‡</text>
          <text class="param-value">{{product.weight}}g</text>
        </view>
      </view>

      <!-- å•†å“è¯¦æƒ…å›¾ç‰‡ -->
      <view class="detail-images" wx:if="{{product.detail_images && product.detail_images.length > 0}}">
        <image wx:for="{{product.detail_images}}" wx:key="index"
               class="detail-image"
               src="{{item.url}}"
               mode="widthFix"
               lazy-load="{{true}}"></image>
      </view>
    </view>

    <!-- ç”¨æˆ·è¯„ä»· -->
    <view class="review-section" wx:if="{{reviewStats && reviewStats.total_count > 0}}">
      <view class="section-header" bindtap="viewAllReviews">
        <text class="section-title">ç”¨æˆ·è¯„ä»· ({{reviewStats.total_count}})</text>
        <view class="section-extra">
          <text class="average-rating">{{reviewStats.average_rating}}åˆ†</text>
          <text class="view-all">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
      </view>

      <!-- è¯„ä»·ç»Ÿè®¡ -->
      <view class="review-stats" wx:if="{{reviewStats.rating_distribution && reviewStats.rating_distribution.length > 0}}">
        <view class="rating-breakdown">
          <view class="rating-item" wx:for="{{reviewStats.rating_distribution}}" wx:key="rating">
            <text class="rating-label">{{item.rating}}æ˜Ÿ</text>
            <progress class="rating-progress" 
                      percent="{{(item.count / reviewStats.total_count) * 100}}"
                      stroke-width="8"
                      activeColor="#FFD700"></progress>
            <text class="rating-count">{{item.count}}</text>
          </view>
        </view>
      </view>

      <!-- è¯„ä»·åˆ—è¡¨ -->
      <view class="review-list" wx:if="{{reviews && reviews.length > 0}}">
        <view class="review-item" wx:for="{{reviews}}" wx:key="id">
          <view class="review-header">
            <image class="reviewer-avatar" src="{{item.user_avatar || '/assets/images/logo.png'}}" mode="aspectFill"></image>
            <view class="reviewer-info">
              <text class="reviewer-name">{{item.user_nickname || 'åŒ¿åç”¨æˆ·'}}</text>
              <view class="review-rating">
                <text class="stars">{{item.star_display || 'â˜†â˜†â˜†â˜†â˜†'}}</text>
                <text class="review-time">{{item.created_at}}</text>
              </view>
            </view>
          </view>
          <view class="review-content">{{item.content || 'ç”¨æˆ·æ²¡æœ‰ç•™ä¸‹è¯„ä»·å†…å®¹'}}</view>
          <view class="review-images" wx:if="{{item.images && item.images.length > 0}}">
            <image wx:for="{{item.images}}" wx:key="index" wx:for-item="img"
                   class="review-image"
                   src="{{img.url}}"
                   mode="aspectFill"></image>
          </view>
          <!-- å•†æˆ·å›å¤ -->
          <view class="merchant-reply" wx:if="{{item.merchant_reply}}">
            <text class="reply-label">å•†æˆ·å›å¤ï¼š</text>
            <text class="reply-content">{{item.merchant_reply}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç›¸å…³å•†å“ -->
    <view class="related-section" wx:if="{{relatedProducts && relatedProducts.length > 0}}">
      <view class="section-header">
        <text class="section-title">ç›¸å…³æ¨è</text>
      </view>
      
      <scroll-view class="related-products" scroll-x="{{true}}">
        <view class="related-item" wx:for="{{relatedProducts}}" wx:key="id"
              data-product-id="{{item.id}}" bindtap="viewRelatedProduct">
          <image class="related-image" src="{{item.thumbnail || '/assets/images/logo.png'}}" mode="aspectFill"></image>
          <view class="related-info">
            <text class="related-name">{{item.name}}</text>
            <text class="related-price">Â¥{{formatPrice(item.current_price || item.price)}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- ç©ºçŠ¶æ€é¡µé¢ -->
  <view class="empty-state" wx:if="{{!loading && !product}}">
    <view class="empty-icon">ğŸ“¦</view>
    <text class="empty-text">å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶</text>
    <view class="empty-actions">
      <view class="empty-btn" bindtap="goBack">è¿”å›ä¸Šé¡µ</view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{product}}">
    <view class="bar-left">
      <view class="bar-item" bindtap="contactService">
        <text class="bar-icon">ğŸ’¬</text>
        <text class="bar-text">å®¢æœ</text>
      </view>
      <view class="bar-item cart-item" bindtap="goToCart">
        <text class="bar-icon">ğŸ›’</text>
        <text class="bar-text">è´­ç‰©è½¦</text>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount > 99 ? '99+' : cartCount}}</view>
      </view>
    </view>
    
    <view class="bar-right">
      <!-- å¦‚æœå•†å“æœ‰åº“å­˜ï¼Œæ˜¾ç¤ºæ­£å¸¸æŒ‰é’® -->
      <block wx:if="{{product.stock > 0 && product.status === 1}}">
        <view class="add-cart-btn" bindtap="showSpecSelector" data-mode="cart">
          <text>åŠ å…¥è´­ç‰©è½¦</text>
        </view>
        <view class="buy-now-btn" bindtap="showSpecSelector" data-mode="buy">
          <text>ç«‹å³è´­ä¹°</text>
        </view>
      </block>
      
      <!-- å¦‚æœæ²¡åº“å­˜ï¼Œæ˜¾ç¤ºç¼ºè´§çŠ¶æ€ -->
      <block wx:else>
        <view class="disabled-btn">
          <text>{{product.stock === 0 ? 'æš‚æ—¶ç¼ºè´§' : 'å•†å“ä¸‹æ¶'}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- æ‚¬æµ®è´­ä¹°æ  -->
  <view class="floating-bar {{showFloatingBar ? 'show' : ''}}" wx:if="{{product && product.stock > 0}}">
    <view class="floating-info">
      <image class="floating-image" src="{{product.thumbnail}}" mode="aspectFill"></image>
      <view class="floating-text">
        <text class="floating-price">Â¥{{formatPrice(product.current_price)}}</text>
        <text class="floating-name">{{product.name}}</text>
      </view>
    </view>
    <view class="floating-actions">
      <view class="floating-cart" bindtap="showSpecSelector" data-mode="cart">åŠ è´­ç‰©è½¦</view>
      <view class="floating-buy" bindtap="showSpecSelector" data-mode="buy">ç«‹å³è´­ä¹°</view>
    </view>
  </view>
</view>

<!-- è§„æ ¼é€‰æ‹©é¢æ¿ -->
<view class="spec-panel-mask" wx:if="{{showSpecPanel}}" bindtap="hideSpecPanel"></view>
<view class="spec-panel {{showSpecPanel ? 'show' : ''}}">
  <view class="spec-panel-header">
    <image class="spec-product-image" src="{{product.thumbnail}}" mode="aspectFill"></image>
    <view class="spec-product-info">
      <text class="spec-product-price">Â¥{{formatPrice(product.current_price)}}</text>
      <text class="spec-product-stock">åº“å­˜{{product.stock}}ä»¶</text>
      <text class="spec-selected">å·²é€‰ï¼š{{getSpecDescription()}}</text>
    </view>
    <view class="spec-panel-close" bindtap="hideSpecPanel">Ã—</view>
  </view>

  <scroll-view class="spec-panel-content" scroll-y="{{true}}">
    <!-- è§„æ ¼é€‰æ‹© -->
    <view class="spec-groups" wx:if="{{product.specifications && product.specifications.length > 0}}">
      <view class="spec-group" wx:for="{{product.specifications}}" wx:key="id" wx:for-item="spec">
        <text class="spec-group-title">{{spec.name}}</text>
        <view class="spec-options">
          <view class="spec-option {{selectedSpecs[spec.id] === option.id ? 'selected' : ''}}"
                wx:for="{{spec.options}}" wx:key="id" wx:for-item="option"
                data-spec-id="{{spec.id}}" data-option-id="{{option.id}}"
                bindtap="selectSpec">
            <text class="spec-option-text">{{option.name}}</text>
            <text class="spec-option-price" wx:if="{{option.price_diff && option.price_diff !== 0}}">
              {{option.price_diff > 0 ? '+' : ''}}Â¥{{formatPrice(option.price_diff)}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ•°é‡é€‰æ‹© -->
    <view class="quantity-section">
      <text class="quantity-label">æ•°é‡</text>
      <view class="quantity-selector">
        <view class="quantity-btn minus {{selectedQuantity <= 1 ? 'disabled' : ''}}"
              data-type="minus" bindtap="changeQuantity">-</view>
        <input class="quantity-input" 
               type="number" 
               value="{{selectedQuantity}}"
               bindinput="inputQuantity"></input>
        <view class="quantity-btn plus {{selectedQuantity >= product.stock ? 'disabled' : ''}}"
              data-type="plus" bindtap="changeQuantity">+</view>
      </view>
    </view>
  </scroll-view>

  <view class="spec-panel-footer">
    <view class="spec-confirm-btn {{specMode === 'cart' ? 'cart-style' : 'buy-style'}}"
          bindtap="{{specMode === 'cart' ? 'addToCart' : 'buyNow'}}">
      <text>{{specMode === 'cart' ? 'åŠ å…¥è´­ç‰©è½¦' : 'ç«‹å³è´­ä¹°'}}</text>
    </view>
  </view>
</view>

<!-- åˆ†äº«é¢æ¿ -->
<view class="share-panel-mask" wx:if="{{showSharePanel}}" bindtap="hideShare"></view>
<view class="share-panel {{showSharePanel ? 'show' : ''}}">
  <view class="share-panel-header">
    <text class="share-panel-title">åˆ†äº«ç»™å¥½å‹</text>
    <view class="share-panel-close" bindtap="hideShare">Ã—</view>
  </view>
  
  <view class="share-options">
    <button class="share-option" open-type="share">
      <text class="share-icon">ğŸ’¬</text>
      <text class="share-text">å¾®ä¿¡å¥½å‹</text>
    </button>
    <view class="share-option" bindtap="generatePoster">
      <text class="share-icon">ğŸ“·</text>
      <text class="share-text">ç”Ÿæˆæµ·æŠ¥</text>
    </view>
  </view>
</view>