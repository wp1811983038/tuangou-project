// pages/category/index.js - ÂÆåÂñÑÁöÑÂàÜÁ±ªÈ°µÈù¢ÔºàÊîØÊåÅÂïÜÊà∑ÂàÜÁ±ªÔºâ
import { getLocation } from '../../utils/location';
import { 
  getCategoriesForCurrentContext,
  getProductsForCurrentContext,
  getMerchantsByCategory,
  getProductsByCategory
} from '../../services/category';

Page({
  data: {
    // ÂàÜÁ±ªÊï∞ÊçÆ
    categories: [],                    // ÊâÄÊúâÂàÜÁ±ª
    currentCategory: null,             // ÂΩìÂâçÈÄâ‰∏≠ÂàÜÁ±ª
    
    // ÂΩìÂâçÂïÜÊà∑‰ø°ÊÅØ
    currentMerchant: null,             // ÂΩìÂâçÈÄâ‰∏≠ÂïÜÊà∑
    isMerchantMode: false,             // ÊòØÂê¶‰∏∫ÂïÜÊà∑Ê®°Âºè
    
    // ‰ΩçÁΩÆ‰ø°ÊÅØ
    location: null,                    // Áî®Êà∑‰ΩçÁΩÆ
    
    // ÊòæÁ§∫Ê®°ÂºèÔºö'merchants' | 'products'
    displayMode: 'products',           // ÈªòËÆ§ÊòæÁ§∫ÂïÜÂìÅÔºàÂïÜÊà∑Ê®°Âºè‰∏ãÂè™ÊòæÁ§∫ÂïÜÂìÅÔºâ
    
    // ÂïÜÊà∑Êï∞ÊçÆ
    merchants: [],                     // ÂïÜÊà∑ÂàóË°®
    merchantsLoading: false,           // ÂïÜÊà∑Âä†ËΩΩÁä∂ÊÄÅ
    merchantsPage: 1,                  // ÂïÜÊà∑È°µÁ†Å
    merchantsHasMore: true,            // ÊòØÂê¶ÊúâÊõ¥Â§öÂïÜÊà∑
    
    // ÂïÜÂìÅÊï∞ÊçÆ
    products: [],                      // ÂïÜÂìÅÂàóË°®
    productsLoading: false,            // ÂïÜÂìÅÂä†ËΩΩÁä∂ÊÄÅ
    productsPage: 1,                   // ÂïÜÂìÅÈ°µÁ†Å
    productsHasMore: true,             // ÊòØÂê¶ÊúâÊõ¥Â§öÂïÜÂìÅ
    
    // ÊêúÁ¥¢ÂíåÁ≠õÈÄâ
    searchKeyword: '',                 // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
    sortBy: 'default',                 // ÊéíÂ∫èÊñπÂºè
    sortOptions: [                     // ÊéíÂ∫èÈÄâÈ°π
      { value: 'default', label: 'ÈªòËÆ§ÊéíÂ∫è' },
      { value: 'sales', label: 'ÈîÄÈáèÊúÄÈ´ò' },
      { value: 'price_asc', label: '‰ª∑Ê†º‰ªé‰ΩéÂà∞È´ò' },
      { value: 'price_desc', label: '‰ª∑Ê†º‰ªéÈ´òÂà∞‰Ωé' },
      { value: 'rating', label: 'ËØÑÂàÜÊúÄÈ´ò' },
      { value: 'created_at', label: 'ÊúÄÊñ∞‰∏äÊû∂' }
    ],
    
    // UIÁä∂ÊÄÅ
    loading: false,                    // È°µÈù¢‰∏ªÂä†ËΩΩÁä∂ÊÄÅ
    showSortPanel: false,              // ÊòæÁ§∫ÊéíÂ∫èÈù¢Êùø
    refreshing: false,                 // ‰∏ãÊãâÂà∑Êñ∞Áä∂ÊÄÅ
    
    // ÂàÜÈ°µÈÖçÁΩÆ
    pageSize: 10
  },

  onLoad: function(options) {
    console.log('üè∑Ô∏è ÂàÜÁ±ªÈ°µÈù¢Âä†ËΩΩÔºåÂèÇÊï∞:', options);
    
    // Ëé∑Âèñ‰º†ÂÖ•ÁöÑÂàÜÁ±ªID
    if (options.category_id) {
      this.setData({ 
        preSelectedCategoryId: parseInt(options.category_id) 
      });
    }
    
    // Ê£ÄÊµãÂΩìÂâçÂïÜÊà∑Áä∂ÊÄÅ
    this.checkCurrentMerchant();
    
    // ÂàùÂßãÂåñÈ°µÈù¢
    this.initPage();
  },

  onShow: function() {
    // È°µÈù¢ÊòæÁ§∫Êó∂ÈáçÊñ∞Ê£ÄÊü•ÂïÜÊà∑Áä∂ÊÄÅÔºàÂèØËÉΩ‰ªéÂÖ∂‰ªñÈ°µÈù¢ËøîÂõûÔºâ
    this.checkCurrentMerchant();
    
    // Ê£ÄÊü•‰ΩçÁΩÆÊùÉÈôê
    this.checkLocationPermission();
  },

  // Ê£ÄÊµãÂΩìÂâçÈÄâ‰∏≠ÂïÜÊà∑
  checkCurrentMerchant() {
    try {
      const currentMerchant = wx.getStorageSync('currentMerchant');
      const isMerchantMode = !!(currentMerchant && currentMerchant.id);
      
      console.log('üè™ ÂΩìÂâçÂïÜÊà∑Áä∂ÊÄÅ:', {
        merchant: currentMerchant?.name || 'Êú™ÈÄâÊã©',
        merchantId: currentMerchant?.id || null,
        isMerchantMode
      });
      
      this.setData({
        currentMerchant: currentMerchant || null,
        isMerchantMode
      });
      
      // ÂïÜÊà∑Ê®°Âºè‰∏ãÂè™ÊòæÁ§∫ÂïÜÂìÅ
      if (isMerchantMode) {
        this.setData({ displayMode: 'products' });
      }
      
      // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
      this.updatePageTitle();
      
    } catch (error) {
      console.error('Ê£ÄÊµãÂïÜÊà∑Áä∂ÊÄÅÂ§±Ë¥•', error);
      this.setData({
        currentMerchant: null,
        isMerchantMode: false
      });
    }
  },

  // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
  updatePageTitle() {
    const { currentMerchant, isMerchantMode } = this.data;
    
    let title = 'ÂïÜÂìÅÂàÜÁ±ª';
    if (isMerchantMode && currentMerchant) {
      title = `${currentMerchant.name} - ÂàÜÁ±ª`;
    }
    
    wx.setNavigationBarTitle({ title });
  },

  // ÂàùÂßãÂåñÈ°µÈù¢
  async initPage() {
    this.setData({ loading: true });
    
    try {
      // Âπ∂Ë°åÂä†ËΩΩ‰ΩçÁΩÆÂíåÂàÜÁ±ªÊï∞ÊçÆ
      await Promise.all([
        this.getCurrentLocation(),
        this.loadCategories()
      ]);
      
    } catch (error) {
      console.error('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•', error);
      wx.showToast({
        title: 'È°µÈù¢Âä†ËΩΩÂ§±Ë¥•',
        icon: 'none'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
  async getCurrentLocation() {
    try {
      const location = await getLocation();
      this.setData({ location });
      console.log('üìç Ëé∑ÂèñÂà∞Áî®Êà∑‰ΩçÁΩÆ:', location);
    } catch (error) {
      console.error('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•', error);
      // ‰ΩçÁΩÆËé∑ÂèñÂ§±Ë¥•‰∏çÈòªÂ°ûÈ°µÈù¢Âä†ËΩΩ
    }
  },

  // Ê£ÄÊü•‰ΩçÁΩÆÊùÉÈôê
  checkLocationPermission() {
    wx.getSetting({
      success: (res) => {
        if (!res.authSetting['scope.userLocation']) {
          wx.showModal({
            title: '‰ΩçÁΩÆÊùÉÈôê',
            content: '‰∏∫‰∫ÜÊèê‰æõÊõ¥Â•ΩÁöÑÊúçÂä°ÔºåËØ∑ÂÖÅËÆ∏Ëé∑ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ',
            confirmText: 'ÂéªËÆæÁΩÆ',
            success: (modalRes) => {
              if (modalRes.confirm) {
                wx.openSetting();
              }
            }
          });
        }
      }
    });
  },

  // Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ
  async loadCategories() {
    try {
      const { currentMerchant } = this.data;
      
      console.log('üè∑Ô∏è ÂºÄÂßãÂä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆÔºåÂïÜÊà∑Ê®°Âºè:', !!currentMerchant?.id);
      
      // ‰ΩøÁî®‰∏ä‰∏ãÊñáÊÑüÁü•ÁöÑÂàÜÁ±ªÂä†ËΩΩ
      const categories = await getCategoriesForCurrentContext(currentMerchant);
      
      // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÂàÜÁ±ª
      const allCategories = [
        { 
          id: 0, 
          name: 'ÂÖ®ÈÉ®', 
          icon: '',
          merchant_count: 0,
          product_count: 0
        },
        ...categories
      ];
      
      // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠ÂàÜÁ±ª
      let currentCategory = allCategories[0];
      const { preSelectedCategoryId } = this.data;
      
      if (preSelectedCategoryId) {
        const targetCategory = allCategories.find(cat => cat.id === preSelectedCategoryId);
        if (targetCategory) {
          currentCategory = targetCategory;
        }
      }
      
      this.setData({
        categories: allCategories,
        currentCategory
      });
      
      console.log(`‚úÖ Âä†ËΩΩ‰∫Ü ${categories.length} ‰∏™ÂàÜÁ±ª`);
      
      // Âä†ËΩΩÂΩìÂâçÂàÜÁ±ªÁöÑÊï∞ÊçÆ
      await this.loadCategoryData(currentCategory.id, true);
      
    } catch (error) {
      console.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•', error);
      wx.showToast({
        title: 'Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•',
        icon: 'none'
      });
    }
  },

  // ÂàáÊç¢ÂàÜÁ±ª
  async switchCategory(e) {
    const { id } = e.currentTarget.dataset;
    const { categories, currentCategory } = this.data;
    
    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂΩìÂâçÂàÜÁ±ªÔºå‰∏çÂÅöÂ§ÑÁêÜ
    if (currentCategory && currentCategory.id === parseInt(id)) return;
    
    // ÊâæÂà∞ÂØπÂ∫îÂàÜÁ±ª
    const category = categories.find(item => item.id === parseInt(id));
    if (!category) return;
    
    console.log(`üè∑Ô∏è ÂàáÊç¢Âà∞ÂàÜÁ±ª: ${category.name}`);
    
    this.setData({
      currentCategory: category,
      merchants: [],
      products: [],
      merchantsPage: 1,
      productsPage: 1,
      merchantsHasMore: true,
      productsHasMore: true
    });
    
    // Âä†ËΩΩÊñ∞ÂàÜÁ±ªÁöÑÊï∞ÊçÆ
    await this.loadCategoryData(category.id, true);
  },

  // Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆÔºàÂïÜÊà∑ÊàñÂïÜÂìÅÔºâ
  async loadCategoryData(categoryId, reset = false) {
    const { displayMode, isMerchantMode } = this.data;
    
    console.log(`üì¶ Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ: categoryId=${categoryId}, mode=${displayMode}, merchantMode=${isMerchantMode}`);
    
    // ÂïÜÊà∑Ê®°Âºè‰∏ãÂè™Âä†ËΩΩÂïÜÂìÅ
    if (isMerchantMode) {
      await this.loadProducts(categoryId, reset);
    } else {
      // ÈùûÂïÜÊà∑Ê®°Âºè‰∏ãÊ†πÊçÆÊòæÁ§∫Ê®°ÂºèÂä†ËΩΩ
      if (displayMode === 'merchants') {
        await this.loadMerchants(categoryId, reset);
      } else {
        await this.loadProducts(categoryId, reset);
      }
    }
  },

  // Âä†ËΩΩÂïÜÊà∑Êï∞ÊçÆ
  async loadMerchants(categoryId, reset = false) {
    const { 
      merchantsLoading, 
      merchantsHasMore, 
      merchantsPage, 
      pageSize,
      location,
      searchKeyword,
      sortBy
    } = this.data;
    
    if (merchantsLoading || (!merchantsHasMore && !reset)) return;
    
    this.setData({ merchantsLoading: true });
    
    try {
      const params = {
        page: reset ? 1 : merchantsPage,
        page_size: pageSize,
        status: 1 // Âè™Ëé∑ÂèñËê•‰∏ö‰∏≠ÁöÑÂïÜÊà∑
      };
      
      // Ê∑ªÂä†ÂàÜÁ±ªÁ≠õÈÄâ
      if (categoryId > 0) {
        params.category_id = categoryId;
      }
      
      // Ê∑ªÂä†‰ΩçÁΩÆÂèÇÊï∞
      if (location && location.latitude && location.longitude) {
        params.latitude = location.latitude;
        params.longitude = location.longitude;
      }
      
      // Ê∑ªÂä†ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
      if (searchKeyword) {
        params.keyword = searchKeyword;
      }
      
      // Ê∑ªÂä†ÊéíÂ∫èÂèÇÊï∞
      if (sortBy !== 'default') {
        if (sortBy === 'rating') {
          params.sort_by = 'rating';
          params.sort_order = 'desc';
        }
      }
      
      const result = await getMerchantsByCategory(params);
      
      // Â§ÑÁêÜË∑ùÁ¶ªËÆ°ÁÆó
      if (location) {
        result.items.forEach(merchant => {
          if (merchant.latitude && merchant.longitude) {
            const { calculateDistance, formatDistance } = require('../../utils/location');
            const distance = calculateDistance(
              location.latitude,
              location.longitude,
              merchant.latitude,
              merchant.longitude
            );
            merchant.distance = formatDistance(distance);
            merchant.distanceValue = distance; // Áî®‰∫éÊéíÂ∫è
          }
        });
      }
      
      this.setData({
        merchants: reset ? result.items : [...this.data.merchants, ...result.items],
        merchantsPage: (reset ? 1 : merchantsPage) + 1,
        merchantsHasMore: result.items.length === pageSize,
        merchantsLoading: false
      });
      
    } catch (error) {
      console.error('Âä†ËΩΩÂïÜÊà∑Â§±Ë¥•', error);
      this.setData({ merchantsLoading: false });
      
      if (reset) {
        wx.showToast({
          title: 'Âä†ËΩΩÂïÜÊà∑Â§±Ë¥•',
          icon: 'none'
        });
      }
    }
  },

  // Âä†ËΩΩÂïÜÂìÅÊï∞ÊçÆ
  async loadProducts(categoryId, reset = false) {
    const { 
      productsLoading, 
      productsHasMore, 
      productsPage, 
      pageSize,
      searchKeyword,
      sortBy,
      currentMerchant
    } = this.data;
    
    if (productsLoading || (!productsHasMore && !reset)) return;
    
    this.setData({ productsLoading: true });
    
    try {
      const params = {
        page: reset ? 1 : productsPage,
        page_size: pageSize,
        status: 1 // Âè™Ëé∑Âèñ‰∏äÊû∂ÂïÜÂìÅ
      };
      
      // Ê∑ªÂä†ÂàÜÁ±ªÁ≠õÈÄâ
      if (categoryId > 0) {
        params.category_id = categoryId;
      }
      
      // Ê∑ªÂä†ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
      if (searchKeyword) {
        params.keyword = searchKeyword;
      }
      
      // Ê∑ªÂä†ÊéíÂ∫èÂèÇÊï∞
      if (sortBy !== 'default') {
        if (sortBy === 'sales') {
          params.sort_by = 'sales';
          params.sort_order = 'desc';
        } else if (sortBy === 'price_asc') {
          params.sort_by = 'current_price';
          params.sort_order = 'asc';
        } else if (sortBy === 'price_desc') {
          params.sort_by = 'current_price';
          params.sort_order = 'desc';
        } else if (sortBy === 'rating') {
          params.sort_by = 'rating';
          params.sort_order = 'desc';
        } else if (sortBy === 'created_at') {
          params.sort_by = 'created_at';
          params.sort_order = 'desc';
        }
      }
      
      console.log('üõçÔ∏è Âä†ËΩΩÂïÜÂìÅÂèÇÊï∞:', params);
      
      // ‰ΩøÁî®‰∏ä‰∏ãÊñáÊÑüÁü•ÁöÑÂïÜÂìÅÂä†ËΩΩ
      const result = await getProductsForCurrentContext(params, currentMerchant);
      
      this.setData({
        products: reset ? result.items : [...this.data.products, ...result.items],
        productsPage: (reset ? 1 : productsPage) + 1,
        productsHasMore: result.items.length === pageSize,
        productsLoading: false
      });
      
      console.log(`‚úÖ Âä†ËΩΩÂïÜÂìÅÂÆåÊàê: ${result.items.length} ‰∏™ÂïÜÂìÅ`);
      
    } catch (error) {
      console.error('Âä†ËΩΩÂïÜÂìÅÂ§±Ë¥•', error);
      this.setData({ productsLoading: false });
      
      if (reset) {
        wx.showToast({
          title: 'Âä†ËΩΩÂïÜÂìÅÂ§±Ë¥•',
          icon: 'none'
        });
      }
    }
  },

  // ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè
  switchDisplayMode(e) {
    const { mode } = e.currentTarget.dataset;
    const { displayMode, currentCategory, isMerchantMode } = this.data;
    
    // ÂïÜÊà∑Ê®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÂàáÊç¢Âà∞ÂïÜÊà∑ËßÜÂõæ
    if (isMerchantMode && mode === 'merchants') {
      wx.showToast({
        title: 'ÂΩìÂâç‰∏∫ÂïÜÊà∑Ê®°ÂºèÔºåÂè™ËÉΩÊü•ÁúãÂïÜÂìÅ',
        icon: 'none'
      });
      return;
    }
    
    if (displayMode === mode) return;
    
    console.log(`üîÑ ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè: ${displayMode} -> ${mode}`);
    
    this.setData({
      displayMode: mode,
      merchants: [],
      products: [],
      merchantsPage: 1,
      productsPage: 1,
      merchantsHasMore: true,
      productsHasMore: true
    });
    
    // Âä†ËΩΩÂØπÂ∫îÊ®°ÂºèÁöÑÊï∞ÊçÆ
    if (currentCategory) {
      this.loadCategoryData(currentCategory.id, true);
    }
  },

  // ÊêúÁ¥¢ÂäüËÉΩ
  onSearchInput(e) {
    const keyword = e.detail.value;
    this.setData({ searchKeyword: keyword });
    
    // Èò≤ÊäñÊêúÁ¥¢
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
      this.performSearch();
    }, 500);
  },

  // ÊâßË°åÊêúÁ¥¢
  async performSearch() {
    const { currentCategory } = this.data;
    if (currentCategory) {
      await this.loadCategoryData(currentCategory.id, true);
    }
  },

  // Ê∏ÖÈô§ÊêúÁ¥¢
  clearSearch() {
    this.setData({ searchKeyword: '' });
    this.performSearch();
  },

  // ÊòæÁ§∫ÊéíÂ∫èÈù¢Êùø
  showSortPanel() {
    this.setData({ showSortPanel: true });
  },

  // ÈöêËóèÊéíÂ∫èÈù¢Êùø
  hideSortPanel() {
    this.setData({ showSortPanel: false });
  },

  // ÈÄâÊã©ÊéíÂ∫èÊñπÂºè
  selectSort(e) {
    const { value } = e.currentTarget.dataset;
    const { sortBy, currentCategory } = this.data;
    
    if (sortBy === value) {
      this.hideSortPanel();
      return;
    }
    
    console.log(`üìä ÂàáÊç¢ÊéíÂ∫è: ${sortBy} -> ${value}`);
    
    this.setData({
      sortBy: value,
      showSortPanel: false
    });
    
    // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
    if (currentCategory) {
      this.loadCategoryData(currentCategory.id, true);
    }
  },

  // Ë∑≥ËΩ¨Âà∞ÊêúÁ¥¢È°µ
  goToSearch() {
    wx.navigateTo({
      url: '/pages/search/index'
    });
  },

  // Ë∑≥ËΩ¨Âà∞ÂïÜÊà∑ËØ¶ÊÉÖÈ°µ
  goToMerchant(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/merchant/detail/index?id=${id}`
    });
  },

  // Ë∑≥ËΩ¨Âà∞ÂïÜÂìÅËØ¶ÊÉÖÈ°µ
  goToProduct(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/product/detail/index?id=${id}`
    });
  },

  // ‰∏äÊãâÂä†ËΩΩÊõ¥Â§ö
  loadMore() {
    const { displayMode, currentCategory } = this.data;
    
    if (!currentCategory) return;
    
    if (displayMode === 'merchants') {
      this.loadMerchants(currentCategory.id, false);
    } else {
      this.loadProducts(currentCategory.id, false);
    }
  },

  // ‰∏ãÊãâÂà∑Êñ∞
  async onPullDownRefresh() {
    this.setData({ refreshing: true });
    
    try {
      // ÈáçÊñ∞Ê£ÄÊµãÂïÜÊà∑Áä∂ÊÄÅ
      this.checkCurrentMerchant();
      
      const { currentCategory } = this.data;
      if (currentCategory) {
        await this.loadCategoryData(currentCategory.id, true);
      }
    } catch (error) {
      console.error('Âà∑Êñ∞Â§±Ë¥•', error);
    } finally {
      this.setData({ refreshing: false });
      wx.stopPullDownRefresh();
    }
  },

  // È°µÈù¢Ëß¶Â∫ï‰∫ã‰ª∂
  onReachBottom() {
    this.loadMore();
  },

  // Ëé∑ÂèñÂΩìÂâçÂàÜÁ±ªÂêçÁß∞
  get currentCategoryName() {
    const { currentCategory } = this.data;
    return currentCategory ? currentCategory.name : 'ÂÖ®ÈÉ®';
  },

  // ËøîÂõûÂÖ®Â±ÄÂàÜÁ±ªÊ®°Âºè
  backToGlobal() {
    console.log('üåç ËøîÂõûÂÖ®Â±ÄÂàÜÁ±ªÊ®°Âºè');
    
    wx.showModal({
      title: 'ÊèêÁ§∫',
      content: 'ÊòØÂê¶ÈÄÄÂá∫ÂïÜÊà∑Ê®°ÂºèÔºåÊü•ÁúãÂÖ®ÈÉ®ÂïÜÊà∑ÂàÜÁ±ªÔºü',
      confirmText: 'Á°ÆÂÆö',
      cancelText: 'ÂèñÊ∂à',
      success: (res) => {
        if (res.confirm) {
          // Ê∏ÖÈô§ÂΩìÂâçÂïÜÊà∑
          wx.removeStorageSync('currentMerchant');
          
          // ÈáçÁΩÆÈ°µÈù¢Áä∂ÊÄÅ
          this.setData({
            currentMerchant: null,
            isMerchantMode: false,
            displayMode: 'products', // ÈáçÁΩÆ‰∏∫ÂïÜÂìÅÊ®°Âºè
            categories: [],
            currentCategory: null,
            products: [],
            merchants: [],
            searchKeyword: '',
            sortBy: 'default'
          });
          
          // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
          wx.setNavigationBarTitle({ title: 'ÂïÜÂìÅÂàÜÁ±ª' });
          
          // ÈáçÊñ∞ÂàùÂßãÂåñÈ°µÈù¢
          this.initPage();
          
          wx.showToast({
            title: 'Â∑≤ÂàáÊç¢Âà∞ÂÖ®Â±ÄÂàÜÁ±ª',
            icon: 'success'
          });
        }
      }
    });
  },

  // Ëé∑ÂèñÂΩìÂâçÊéíÂ∫èÂêçÁß∞
  get currentSortName() {
    const { sortBy, sortOptions } = this.data;
    const option = sortOptions.find(opt => opt.value === sortBy);
    return option ? option.label : 'ÈªòËÆ§ÊéíÂ∫è';
  }
});